# Vibma Setup Guide

> **This guide assumes you've cloned the repo and are running commands from the project root.** If you haven't yet:
> ```bash
> git clone https://github.com/ufira-ai/vibma.git
> cd vibma
> ```
> Looking for a zero-download setup instead? See [CARRYME.md](./CARRYME.md).

## Prerequisites

- [Node.js](https://nodejs.org) (v18+)
- [Figma](https://figma.com) desktop or web app
- An AI coding tool with MCP support (Claude Code, Cursor, etc.)

## 1. Install dependencies

```bash
npm install
npm run build
```

## 2. Start the WebSocket relay

This bridges the MCP server and the Figma plugin via channels. Everything runs locally on your machine — no data leaves localhost.

```bash
npm run socket
```

You should see: `WebSocket server running on port 3055`

### About ports

Vibma defaults to port **3055**. The Figma plugin manifest whitelists ports **3055–3058** so you have alternatives if 3055 is already in use (e.g., by the upstream cursor-talk-to-figma-mcp project). To use a different port, set the `VIBMA_PORT` env var:

```bash
VIBMA_PORT=3056 npm run socket
```

The MCP server reads the same env var, so it will match automatically. You only need to also update the **port field in the Figma plugin UI** before clicking Connect.

The Figma plugin can only connect to ports 3055, 3056, 3057, or 3058. This is a Figma platform restriction — the manifest's `allowedDomains` cannot be changed at runtime.

## 3. Install the Figma plugin

1. In Figma, go to **Plugins > Development > Import plugin from manifest...**
2. Select `plugin/manifest.json` from this repo (generated by `npm run build`)
3. Run the plugin — it will show a connection panel

## 4. Configure MCP in your AI tool

Add to your MCP config (e.g. `.cursor/mcp.json`, `.claude.json`, or `.mcp.json`):

```json
{
  "mcpServers": {
    "Vibma": {
      "command": "node",
      "args": ["dist/mcp.js"]
    }
  }
}
```

Or run from source (no build step, good for development):

```json
{
  "mcpServers": {
    "Vibma": {
      "command": "npx",
      "args": ["tsx", "src/mcp.ts"]
    }
  }
}
```

If using a non-default port, pass `--port=`:

```json
{
  "mcpServers": {
    "Vibma": {
      "command": "node",
      "args": ["dist/mcp.js", "--port=3056"]
    }
  }
}
```

## 5. Connect

1. In the Figma plugin, set the channel name to `vibma` (or any name you like)
2. Click **Connect**
3. In your AI tool, call `join_channel` with the same channel name (defaults to `vibma`)
4. Call `ping` — you should get back `pong` with your document name

## Troubleshooting

**Plugin won't connect to WebSocket**: Make sure the relay is running. The plugin connects to `ws://localhost:3055` by default.

**MCP shows disconnected**: Restart your AI tool after changing MCP config. Stdio-based MCP servers can't hot-reload.

**Port already in use**: See the agent instructions below for automated port resolution, or manually kill the process (`lsof -ti:3055 | xargs kill`).

---

## Instructions for AI Agents

The section below is for AI agents setting up Vibma on behalf of a user. Follow these steps in order.

### Port resolution

Before starting the socket relay, check if the default port is available:

```bash
lsof -ti:3055
```

If the port is occupied, ask the user:

> Port 3055 is already in use by another process (PID: <pid>). Would you like to:
> 1. **Kill the process** on port 3055 and use it for Vibma
> 2. **Use the next available port** (3056, 3057, or 3058)

If the user chooses option 2, scan ports in order:

```bash
lsof -ti:3056 || echo "3056 is free"
lsof -ti:3057 || echo "3057 is free"
lsof -ti:3058 || echo "3058 is free"
```

Use the first free port. Set `VIBMA_PORT=<port>` when starting the relay, and pass `--port=<port>` to the MCP server in the MCP config. Inform the user to set the same port in the Figma plugin UI before clicking Connect.

If all four ports (3055–3058) are occupied, tell the user they need to free one.

### Connection verification

After the user says they've connected the Figma plugin:

1. Call `join_channel` (defaults to channel `vibma` — use a different name only if the user specifies one).
2. Call `ping`. Expected response: `{ status: "pong", documentName: "...", currentPage: "...", timestamp: ... }`

If `ping` returns a `pong` with a document name, the full chain is verified. Proceed with design tasks.

If any tool times out after a successful `join_channel`, the Figma plugin is not connected to the relay. The timeout error will include the port and channel the MCP server is using. Ask the user to check the Figma plugin window and confirm:
- The **port** matches what MCP is using
- The **channel name** matches what MCP joined
- The plugin status shows **Connected**
